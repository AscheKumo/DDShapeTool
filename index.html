<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Pregnancy & Boob Sizer (Slider-Calibrated 100 Shapes)</title>
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #121212;
      color: #f5f5f5;
      margin: 0;
      padding: 1.5rem;
    }
    h1 {
      margin-top: 0;
      font-size: 1.6rem;
    }
    .card {
      background: #1e1e1e;
      border-radius: 8px;
      padding: 1rem 1.25rem;
      margin-bottom: 1rem;
      box-shadow: 0 0 0 1px #333;
    }
    label {
      font-size: 0.95rem;
    }
    input[type="file"],
    input[type="number"] {
      margin-top: 0.25rem;
      margin-bottom: 0.75rem;
    }
    input[type="number"] {
      background: #181818;
      border: 1px solid #444;
      border-radius: 4px;
      color: #f5f5f5;
      padding: 0.25rem 0.4rem;
      font-size: 0.9rem;
    }
    button {
      background: #7b5cff;
      color: white;
      border: none;
      border-radius: 4px;
      padding: 0.4rem 0.8rem;
      margin: 0.25rem 0.25rem 0.25rem 0;
      cursor: pointer;
      font-size: 0.9rem;
    }
    button:disabled {
      opacity: 0.4;
      cursor: default;
    }
    button.secondary {
      background: #333;
    }
    .small {
      font-size: 0.8rem;
      color: #aaa;
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 1rem;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 0.5rem;
      font-size: 0.85rem;
    }
    th, td {
      border-bottom: 1px solid #333;
      padding: 0.35rem 0.4rem;
      vertical-align: middle;
      text-align: right;
    }
    th {
      background: #222;
      position: sticky;
      top: 0;
      z-index: 2;
    }
    tbody tr:nth-child(even) {
      background: #181818;
    }
    .download-link {
      display: inline-block;
      margin-top: 0.5rem;
      font-size: 0.9rem;
    }
  </style>
</head>
<body>
  <h1>Pregnancy & Boob Size Grid (100 XML Shapes)</h1>

  <div class="card">
    <p>
      Upload a base shape XML. This tool will:
    </p>
    <ul class="small">
      <li>Use param <strong>157</strong> as <strong>belly</strong></li>
      <li>Use param <strong>105</strong> as <strong>boobs</strong></li>
      <li>Assume those sliders are 0–100 in the viewer, calibrated to internal XML range 0.0–1.0</li>
      <li>Generate a 10×10 grid of shapes from base slider value → your chosen max slider value</li>
    </ul>

    <div class="grid">
      <div>
        <label><strong>Base Shape XML</strong></label><br />
        <input type="file" id="baseFile" accept=".xml" />
        <div id="baseFileName" class="small"></div>
        <div id="status" class="small">No file loaded yet.</div>
      </div>

      <div>
        <label><strong>Max Belly Slider (0–100)</strong></label><br />
        <input type="number" id="bellyMaxSlider" min="0" max="100" step="0.1" placeholder="e.g. 80" style="width:120px;" /><br />
        <span class="small">p1 belly = base slider, p10 belly = this slider value.</span>
      </div>

      <div>
        <label><strong>Max Boob Slider (0–100)</strong></label><br />
        <input type="number" id="boobMaxSlider" min="0" max="100" step="0.1" placeholder="e.g. 90" style="width:120px;" /><br />
        <span class="small">b1 boobs = base slider, b10 boobs = this slider value.</span>
      </div>

      <div>
        <strong>Detected base values</strong><br />
        <div id="bellyInfo" class="small">Belly: –</div>
        <div id="boobInfo" class="small">Boobs: –</div>
      </div>
    </div>

    <div style="margin-top:1rem;">
      <button id="btnPreview" class="secondary" disabled>Preview Value Grid</button>
      <button id="btnGenerate" disabled>Generate ZIP (100 Shapes)</button>
      <div id="generateStatus" class="small"></div>
      <div id="downloadContainer"></div>
    </div>
  </div>

  <div class="card" id="previewCard" style="display:none;">
    <strong>Preview: Belly/Boob Internal Values</strong>
    <p class="small">Each cell shows the internal XML values for that slider combo (belly, boobs).</p>
    <div class="table-container">
      <table>
        <thead><tr id="previewHeader"></tr></thead>
        <tbody id="previewBody"></tbody>
      </table>
    </div>
  </div>

  <!-- JSZip for ZIP creation -->
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>

  <script>
    // Fixed param IDs
    const BELLY_PARAM_ID = "157"; // belly size
    const BOOB_PARAM_ID  = "105"; // breast size

    // Calibrated from your min/max avatar examples:
    // Slider 0  -> internal 0.0
    // Slider 100 -> internal 1.0
    const BELLY_MIN_INTERNAL = 0.0;
    const BELLY_MAX_INTERNAL = 1.0;
    const BOOB_MIN_INTERNAL  = 0.0;
    const BOOB_MAX_INTERNAL  = 1.0;

    let baseXmlDoc = null;
    let baseRawText = "";
    let baseFileName = "";

    let bellyBaseInternal = null;
    let boobBaseInternal  = null;

    const baseFileInput    = document.getElementById("baseFile");
    const baseFileNameEl   = document.getElementById("baseFileName");
    const statusEl         = document.getElementById("status");
    const bellyMaxSliderEl = document.getElementById("bellyMaxSlider");
    const boobMaxSliderEl  = document.getElementById("boobMaxSlider");
    const bellyInfoEl      = document.getElementById("bellyInfo");
    const boobInfoEl       = document.getElementById("boobInfo");

    const btnPreview       = document.getElementById("btnPreview");
    const btnGenerate      = document.getElementById("btnGenerate");
    const previewCard      = document.getElementById("previewCard");
    const previewHeader    = document.getElementById("previewHeader");
    const previewBody      = document.getElementById("previewBody");
    const generateStatus   = document.getElementById("generateStatus");
    const downloadContainer = document.getElementById("downloadContainer");

    baseFileInput.addEventListener("change", handleBaseFile);
    btnPreview.addEventListener("click", previewGrid);
    btnGenerate.addEventListener("click", generateZip);

    function handleBaseFile() {
      const file = baseFileInput.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = e => {
        const text = e.target.result;
        const parser = new DOMParser();
        const xml = parser.parseFromString(text, "application/xml");

        if (xml.getElementsByTagName("parsererror").length) {
          alert("XML parse error.");
          return;
        }

        baseXmlDoc = xml;
        baseRawText = text;
        baseFileName = file.name;

        baseFileNameEl.textContent = "Loaded: " + baseFileName;
        statusEl.textContent = "Base shape loaded. Enter slider max values and generate.";

        detectBaseValues();
        btnPreview.disabled  = false;
        btnGenerate.disabled = false;
      };
      reader.readAsText(file);
    }

    function detectBaseValues() {
      if (!baseXmlDoc) return;

      const params = baseXmlDoc.getElementsByTagName("param");
      bellyBaseInternal = null;
      boobBaseInternal  = null;

      for (let p of params) {
        const id = p.getAttribute("id");
        const valStr = p.getAttribute("value") || "0";
        const val = parseFloat(valStr);

        if (id === BELLY_PARAM_ID) {
          bellyBaseInternal = val;
        }
        if (id === BOOB_PARAM_ID) {
          boobBaseInternal = val;
        }
      }

      if (bellyBaseInternal == null || boobBaseInternal == null) {
        statusEl.textContent = "Could not find param 157 and/or 105 in this shape.";
        btnPreview.disabled  = true;
        btnGenerate.disabled = true;
        return;
      }

      const bellyBaseSlider = sliderFromInternal(
        BELLY_MIN_INTERNAL,
        BELLY_MAX_INTERNAL,
        bellyBaseInternal
      );
      const boobBaseSlider = sliderFromInternal(
        BOOB_MIN_INTERNAL,
        BOOB_MAX_INTERNAL,
        boobBaseInternal
      );

      bellyInfoEl.textContent =
        `Belly (id 157): internal = ${bellyBaseInternal.toFixed(3)}, slider ≈ ${bellyBaseSlider.toFixed(1)}`;
      boobInfoEl.textContent =
        `Boobs (id 105): internal = ${boobBaseInternal.toFixed(3)}, slider ≈ ${boobBaseSlider.toFixed(1)}`;
    }

    function internalFromSlider(minInternal, maxInternal, sliderVal) {
      return minInternal + (maxInternal - minInternal) * (sliderVal / 100);
    }

    function sliderFromInternal(minInternal, maxInternal, internal) {
      const span = maxInternal - minInternal;
      if (Math.abs(span) < 1e-9) return 0;
      return ((internal - minInternal) / span) * 100;
    }

    function makeSliderArray(baseSlider, maxSlider) {
      const arr = [];
      for (let i = 0; i < 10; i++) {
        const t = i / 9;
        arr.push(baseSlider + (maxSlider - baseSlider) * t);
      }
      return arr;
    }

    function computeArrays() {
      if (bellyBaseInternal == null || boobBaseInternal == null) {
        throw new Error("Base belly/boob internal values not detected.");
      }

      const bellyMaxSlider = parseFloat(bellyMaxSliderEl.value);
      const boobMaxSlider  = parseFloat(boobMaxSliderEl.value);

      if (isNaN(bellyMaxSlider) || isNaN(boobMaxSlider)) {
        throw new Error("Enter numeric max slider values for belly and boobs.");
      }

      const bellyBaseSlider = sliderFromInternal(
        BELLY_MIN_INTERNAL,
        BELLY_MAX_INTERNAL,
        bellyBaseInternal
      );
      const boobBaseSlider = sliderFromInternal(
        BOOB_MIN_INTERNAL,
        BOOB_MAX_INTERNAL,
        boobBaseInternal
      );

      const bellySliderArr = makeSliderArray(bellyBaseSlider, bellyMaxSlider);
      const boobSliderArr  = makeSliderArray(boobBaseSlider,  boobMaxSlider);

      const bellyInternalArr = bellySliderArr.map(s =>
        internalFromSlider(BELLY_MIN_INTERNAL, BELLY_MAX_INTERNAL, s)
      );
      const boobInternalArr  = boobSliderArr.map(s =>
        internalFromSlider(BOOB_MIN_INTERNAL, BOOB_MAX_INTERNAL, s)
      );

      return {
        bellySliderArr,
        boobSliderArr,
        bellyInternalArr,
        boobInternalArr
      };
    }

    function previewGrid() {
      try {
        const { bellyInternalArr, boobInternalArr } = computeArrays();

        previewHeader.innerHTML = "";
        previewBody.innerHTML   = "";

        const headTh = document.createElement("th");
        headTh.textContent = "p\\b";
        previewHeader.appendChild(headTh);

        for (let b = 1; b <= 10; b++) {
          const th = document.createElement("th");
          th.textContent = "b" + b;
          previewHeader.appendChild(th);
        }

        for (let p = 0; p < 10; p++) {
          const tr = document.createElement("tr");
          const rowHead = document.createElement("td");
          rowHead.textContent = "p" + (p + 1);
          rowHead.style.textAlign = "left";
          tr.appendChild(rowHead);

          for (let b = 0; b < 10; b++) {
            const td = document.createElement("td");
            const bellyVal = bellyInternalArr[p];
            const boobVal  = boobInternalArr[b];
            td.textContent =
              `belly ${bellyVal.toFixed(3)}, boobs ${boobVal.toFixed(3)}`;
            tr.appendChild(td);
          }

          previewBody.appendChild(tr);
        }

        previewCard.style.display = "block";
      } catch (err) {
        alert(err.message);
      }
    }

    async function generateZip() {
      generateStatus.textContent = "Generating...";
      downloadContainer.innerHTML = "";

      let arrays;
      try {
        arrays = computeArrays();
      } catch (err) {
        alert(err.message);
        generateStatus.textContent = "";
        return;
      }

      const { bellyInternalArr, boobInternalArr } = arrays;

      const zip = new JSZip();

      for (let pi = 0; pi < 10; pi++) {
        for (let bi = 0; bi < 10; bi++) {
          const bellyVal = bellyInternalArr[pi];
          const boobVal  = boobInternalArr[bi];
          const xmlOut = generateShapeXml(bellyVal, boobVal);

          const fileName = `p${pi+1} b${bi+1}.xml`;
          zip.file(fileName, xmlOut);
        }
      }

      const zipBase = baseFileName.replace(/\.xml$/i, "");
      const zipName = `${zipBase}_preg-boob-grid.zip`;

      const blob = await zip.generateAsync({ type: "blob" });
      const url  = URL.createObjectURL(blob);

      const a = document.createElement("a");
      a.href = url;
      a.download = zipName;
      a.textContent = `Download ${zipName}`;
      a.className = "download-link";

      downloadContainer.appendChild(a);
      generateStatus.textContent = "Done.";
    }

    function generateShapeXml(bellyVal, boobVal) {
      const newDoc = baseXmlDoc.cloneNode(true);
      const params = newDoc.getElementsByTagName("param");

      for (let p of params) {
        const id = p.getAttribute("id");
        if (id === BELLY_PARAM_ID) {
          p.setAttribute("value", bellyVal.toString());
        }
        if (id === BOOB_PARAM_ID) {
          p.setAttribute("value", boobVal.toString());
        }
      }

      const serializer = new XMLSerializer();
      let xmlBody = serializer.serializeToString(newDoc);

      let header = "";
      if (baseRawText) {
        const m = baseRawText.match(/^\s*<\?xml[^>]*\?>/i);
        if (m) header = m[0] + "\n";
      }
      if (!header) header = '<?xml version="1.0" encoding="UTF-8"?>\n';

      return header + xmlBody;
    }
  </script>
</body>
</html>
